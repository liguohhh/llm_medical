# 精确匹配搜索算法

## 算法概述

精确匹配搜索算法是一种高效的关键词匹配系统，专为医疗问答场景设计。它结合了字符串匹配和简化版的有限自动机思想，实现了对用户查询的快速、准确响应，并支持多级关联匹配以提高召回率，同时避免结果中出现重复条目。

## 实现原理

### 1. 查询预处理

查询预处理是搜索算法的第一步，旨在规范化用户输入：

```python
processed_query = ''.join(c for c in query if c.isalnum() or c.isspace() or ord(c) > 127)
```

这一步骤实现了：
- 保留字母、数字、空格和中文字符
- 去除标点符号和特殊字符
- 保持原始文本大小写，确保专业术语匹配

### 2. 初始关键词匹配（第一层）

算法采用直接字符串包含检查，这是一种高效的简化版有限自动机实现：

```python
for keyword in keyword_dict:
    if keyword in processed_query:
        matched_keyword_ids.add(keyword_dict[keyword])
```

优势：
- **完整词匹配**：保持医疗术语的完整性，避免分词可能带来的语义丢失
- **高效**：直接使用Python内置的字符串包含检查，计算复杂度低
- **支持多语言**：同时适用于中文、英文和混合文本
- **保留专业术语**：医疗术语往往是专有名词，直接匹配更为准确

### 3. 多级关联匹配与去重

算法支持配置化的多级关联匹配，可根据搜索深度参数动态调整，并确保每个条目只会被匹配一次：

```python
# 存储结果和已处理的条目ID
results = []
processed_entry_ids = set()  # 用于跟踪已处理的条目ID，避免重复添加

# 开始搜索循环
while current_depth <= search_depth and all_matched_ids_by_level[current_depth]:
    # 处理当前深度的匹配...
    
    # 处理匹配的条目，跟踪已处理ID避免重复
    new_entries_this_level = []  # 本层级新增的条目，用于下一级关联
    
    for entry in matched_entries:
        if entry.id not in processed_entry_ids:
            processed_entry_ids.add(entry.id)  # 标记为已处理
            entry_data = {
                # 条目数据...
                "match_level": current_depth  # 记录匹配级别
            }
            results.append(entry_data)
            new_entries_this_level.append(entry_data)  # 添加到本层级新增条目
```

特点：
- **深度可配置**：支持任意深度的关联匹配，由`search_depth`参数控制
- **防止重复条目**：使用`processed_entry_ids`集合跟踪已处理的条目ID，确保同一条目不会被重复添加到结果中
- **层级精确传递**：通过`new_entries_this_level`列表，确保只有当前层新匹配的条目会被用于下一层关联
- **防止循环匹配**：通过跟踪已匹配关键词和条目，避免重复匹配
- **日志追踪**：记录每个深度级别找到的匹配数量，便于调试和优化

搜索深度说明：
- 深度=1：仅进行直接关键词匹配
- 深度=2：在直接匹配基础上，再进行一次关联匹配
- 深度=3：在二次匹配基础上，再进行一次关联匹配
- 以此类推...

### 4. 权重排序

结果基于条目权重和匹配级别进行排序：

```python
results.sort(key=lambda x: (x["entry"]["weight"], x["entry"]["match_level"]), reverse=True)
```

排序逻辑：
- 优先考虑条目的预设权重（医学重要性）
- 同等权重下，优先展示匹配级别较低的条目（直接匹配优先）
- 结果可限制数量，保证响应的精确性

## 与传统分词方法对比

| 特性 | 多级关联匹配算法 | 传统分词 |
|------|--------------|---------|
| 完整词保留 | ✓ | ✗ |
| 医学术语准确性 | 高 | 较低 |
| 计算效率 | 高 | 中等 |
| 实现复杂度 | 低 | 高 |
| 语言适应性 | 多语言 | 通常单语言 |
| 术语更新 | 易 | 较难 |
| 关联发现能力 | 可配置深度 | 有限 |
| 结果重复控制 | 严格去重 | 通常需后处理 |

## 优化方向

1. **关键词索引优化**：对长关键词建立索引，进一步提高匹配速度
2. **模糊匹配支持**：增加编辑距离算法，支持轻微拼写错误
3. **语义向量增强**：结合向量搜索，提供语义层面的匹配
4. **用户反馈学习**：根据用户反馈调整条目权重
5. **匹配深度自适应**：基于查询特征自动调整最佳匹配深度
6. **权重动态调整**：根据条目被匹配的深度级别动态调整展示权重

## 应用场景

该算法特别适合以下场景：
- 医疗问答系统中的精确查询
- 需要保持专业术语完整性的领域
- 对响应速度和准确性有高要求的系统
- 混合语言环境（如中英混合的医学术语）
- 需要发现间接关联的知识场景
- 要求结果无重复的严格场景

## 总结

多级关联匹配算法在医疗问答系统中具有明显优势，通过配置化的深度匹配、严格的去重机制和防循环策略，能够高效、准确地响应用户查询，同时发现潜在的知识关联，保持医学术语的专业性和完整性，提供无重复的高质量结果。 